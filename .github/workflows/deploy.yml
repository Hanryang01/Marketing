name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build React app
      run: npm run build
      
    - name: Deploy to AWS EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /var/www/marketing.sihm.co.kr
          
          # Git ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          git pull origin main
          
          # ì˜ì¡´ì„± ì„¤ì¹˜
          npm ci --production
          
          # React ì•± ë¹Œë“œ
          npm run build
          
          # PM2 ì•± ì¬ì‹œì‘
          pm2 restart sihm-admin
          
          # Nginx ì„¤ì • ë¦¬ë¡œë“œ
          sudo systemctl reload nginx
          
          # ë°°í¬ ì™„ë£Œ ë¡œê·¸
          echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸŒ ì›¹ì‚¬ì´íŠ¸: https://marketing.sihm.co.kr"
